---
title: "Exploratory Data Analysis"
output: html_document
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(plotly)
library(crosstalk)
library(htmltools)
theme_set(theme_minimal())

# Controls bar helper
controls_bar <- function(...) {
  htmltools::tags$div(class = "controls-bar", ...)
}
```

```{r data, echo=FALSE, message=FALSE}
# Load and prepare data
poke <- readr::read_csv("Data/pokemon_clean.csv", show_col_types = FALSE) |>
  mutate(
    type1 = forcats::fct_drop(as.factor(stringr::str_to_title(type1))),
    type2 = forcats::fct_drop(as.factor(stringr::str_to_title(type2))),
    generation = as.factor(generation),
    name  = as.character(name)
  )

# Pokémon Type palette (common hex values)
type_cols <- c(
  "Bug"      = "#A6B91A", "Dark"     = "#705746", "Dragon"   = "#6F35FC",
  "Electric" = "#F7D02C", "Fairy"    = "#D685AD", "Fighting" = "#C22E28",
  "Fire"     = "#EE8130", "Flying"   = "#A98FF3", "Ghost"    = "#735797",
  "Grass"    = "#7AC74C", "Ground"   = "#E2BF65", "Ice"      = "#96D9D6",
  "Normal"   = "#A8A77A", "Poison"   = "#A33EA1", "Psychic"  = "#F95587",
  "Rock"     = "#B6A136", "Steel"    = "#B7B7CE", "Water"    = "#6390F0"
)

# Row-wise hex color for exact mapping in plots
poke <- poke |>
  mutate(
    color_hex = unname(type_cols[as.character(type1)]),
    color_hex = ifelse(is.na(color_hex), "#555555", color_hex),
    hover_total = paste0(
      "<b style='font-size:13px;'>", name, "</b>",
      "<br><span style='opacity:.8;'>Type:</span> ", type1,
      ifelse(is.na(type2) | type2 == "None", "", paste0(" / ", type2)),
      "<br><span style='opacity:.8;'>Total:</span> ", base_total
    )
  )

# Long format for per-stat plots
stat_cols <- c("hp","attack","defense","sp_attack","sp_defense","speed")
poke_long <- poke |>
  select(name, type1, type2, generation, color_hex, all_of(stat_cols)) |>
  tidyr::pivot_longer(
    cols = all_of(stat_cols),
    names_to = "stat_name",
    values_to = "stat_value"
  ) |>
  mutate(
    stat_label = dplyr::recode(
      stat_name,
      hp = "HP", attack = "Attack", defense = "Defense",
      sp_attack = "Sp. Attack", sp_defense = "Sp. Defense", speed = "Speed"
    ),
    hover_stat = paste0(
      "<b style='font-size:13px;'>", name, "</b>",
      "<br><span style='opacity:.8;'>Type:</span> ", type1,
      ifelse(is.na(type2) | type2 == "None", "", paste0(" / ", type2)),
      "<br><span style='opacity:.8;'>", stat_label, ":</span> ", stat_value
    )
  )

# Jitter vectors for visual separation
set.seed(42); yjit_total <- jitter(rep(0, nrow(poke)), amount = 0.08)
set.seed(7);  yjit_stat  <- jitter(rep(0, nrow(poke_long)), amount = 0.10)

# Plot theme helper
apply_plot_theme <- function(p) {
  layout(
    p,
    paper_bgcolor = "rgba(255,255,255,1)",
    plot_bgcolor  = "rgba(255,255,255,1)",
    font = list(family = "Montserrat, Arial, sans-serif", color = "#111"),
    xaxis = list(zeroline = FALSE, gridcolor = "rgba(0,0,0,0.08)"),
    yaxis = list(zeroline = FALSE, gridcolor = "rgba(0,0,0,0.08)"),
    margin = list(l = 60, r = 40, t = 70, b = 60)
  )
}
```

## Total Base Stats

This section examines the overall distribution of total base stats across all Pokémon. Most Pokémon cluster in the mid-range, with fewer occupying the very low or very high ends of the spectrum. Seeing this baseline spread helps contextualize where different groups sit and prepares us for the comparisons and modeling that follow.

```{r p1, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
# Shared data for plot 1
sd1 <- SharedData$new(
  poke |> select(name, type1, type2, generation, base_total, color_hex, hover_total),
  group = "p1"
)

# Controls above the plot (wrap each in .ctrl for width control)
ctrls1 <- controls_bar(
  tags$div(class = "ctrl", filter_select("p1_gen",  "Generation",  sd1, ~generation, multiple = FALSE)),
  tags$div(class = "ctrl", filter_select("p1_type", "Primary Type", sd1, ~type1,     multiple = FALSE))
)

# Plot
p1 <- plot_ly(
  sd1,
  x = ~base_total,
  y = yjit_total,
  text = ~hover_total,
  type = "scatter",
  mode = "markers",
  hovertemplate = "%{text}<extra></extra>",
  marker = list(
    size = 9, opacity = 0.92,
    line = list(color = "rgba(0,0,0,0.35)", width = 1.2)
  )
) |>
  add_markers(marker = list(color = ~color_hex), showlegend = FALSE) |>
  layout(
    title = list(
      text = "Distribution of Pokémon Total Base Stats",
      font = list(family = "PocketMonk, Montserrat, sans-serif", size = 26)
    ),
    xaxis = list(title = "Total Base Stats", rangeslider = list(visible = TRUE)),
    yaxis = list(title = "", showticklabels = FALSE, range = c(-0.4, 0.4))
  )

p1 <- apply_plot_theme(p1)
htmltools::tagList(ctrls1, p1)
```

## Total Base Stats by Primary Type

Here we explore how total base stats differ across primary types. Some types, such as Dragon, Steel, and Psychic, tend to occupy higher total ranges, while others, like Bug, Normal, and Poison, more often sit lower. Despite noticeable shifts, there is still substantial overlap, which motivates formal testing with ANOVA and Tukey in the Analysis page.

```{r p2, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
sd2 <- SharedData$new(
  poke |> select(name, type1, type2, generation, base_total, color_hex, hover_total),
  group = "p2"
)

ctrls2 <- controls_bar(
  tags$div(class = "ctrl", filter_select("p2_type", "Primary Type", sd2, ~type1, multiple = FALSE))
)

p2 <- plot_ly(
  sd2,
  x = ~base_total,
  y = yjit_total,
  text = ~hover_total,
  type = "scatter",
  mode = "markers",
  hovertemplate = "%{text}<extra></extra>",
  marker = list(
    size = 10, opacity = 0.95,
    line = list(color = "rgba(0,0,0,0.45)", width = 1.4)
  )
) |>
  add_markers(marker = list(color = ~color_hex), showlegend = FALSE) |>
  layout(
    title = list(
      text = "Total Base Stats by Primary Type",
      font = list(family = "PocketMonk, Montserrat, sans-serif", size = 26)
    ),
    xaxis = list(title = "Total Base Stats"),
    yaxis = list(title = "", showticklabels = FALSE, range = c(-0.35, 0.35))
  )

p2 <- apply_plot_theme(p2)
htmltools::tagList(ctrls2, p2)
```

## Select by Stat

This view focuses on the distribution of a single stat—HP, Attack, Defense, Sp. Attack, Sp. Defense, or Speed—and how Pokémon populate that range. Each stat exhibits a distinct shape with its own tails and clusters. Filtering by stat highlights where different types tend to concentrate, informing how individual attributes contribute to overall strength.

```{r p3, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
sd3 <- SharedData$new(
  poke_long |> select(name, type1, type2, generation, stat_name, stat_label, stat_value, color_hex, hover_stat),
  group = "p3"
)

ctrls3 <- controls_bar(
  tags$div(class = "ctrl", filter_select("p3_stat", "Stat", sd3, ~stat_label, multiple = FALSE))
)

p3 <- plot_ly(
  sd3,
  x = ~stat_value,
  y = yjit_stat,
  text = ~hover_stat,
  type = "scatter",
  mode = "markers",
  hovertemplate = "%{text}<extra></extra>",
  marker = list(
    size = 9, opacity = 0.92,
    line = list(color = "rgba(0,0,0,0.35)", width = 1.2)
  )
) |>
  add_markers(marker = list(color = ~color_hex), showlegend = FALSE) |>
  layout(
    title = list(
      text = "Distribution of Selected Stat",
      font = list(family = "PocketMonk, Montserrat, sans-serif", size = 26)
    ),
    xaxis = list(title = "Stat Value", rangeslider = list(visible = TRUE)),
    yaxis = list(title = "", showticklabels = FALSE, range = c(-0.4, 0.4))
  )

p3 <- apply_plot_theme(p3)
htmltools::tagList(ctrls3, p3)
```

## Select by Stat and Type

By combining a selected stat with primary type filtering, we can see how types align with characteristic stat profiles. Some types cluster around stronger offensive attributes (e.g., Attack or Sp. Attack), while others appear more dispersed or balanced. These patterns support the idea that type is associated with systematic differences in stat distributions.

```{r p4, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
sd4 <- SharedData$new(
  poke_long |> select(name, type1, type2, generation, stat_name, stat_label, stat_value, color_hex, hover_stat),
  group = "p4"
)

ctrls4 <- controls_bar(
  tags$div(class = "ctrl", filter_select("p4_stat", "Stat",        sd4, ~stat_label, multiple = FALSE)),
  tags$div(class = "ctrl", filter_select("p4_type", "Primary Type", sd4, ~type1,     multiple = FALSE))
)

p4 <- plot_ly(
  sd4,
  x = ~stat_value,
  y = yjit_stat,
  text = ~hover_stat,
  type = "scatter",
  mode = "markers",
  hovertemplate = "%{text}<extra></extra>",
  marker = list(
    size = 9, opacity = 0.92,
    line = list(color = "rgba(0,0,0,0.35)", width = 1.2)
  )
) |>
  add_markers(marker = list(color = ~color_hex), showlegend = FALSE) |>
  layout(
    title = list(
      text = "Filter by Stat and Type",
      font = list(family = "PocketMonk, Montserrat, sans-serif", size = 26)
    ),
    xaxis = list(title = "Stat Value", rangeslider = list(visible = TRUE)),
    yaxis = list(title = "", showticklabels = FALSE, range = c(-0.4, 0.4))
  )

p4 <- apply_plot_theme(p4)
htmltools::tagList(ctrls4, p4)
```

## Height vs. Weight by Total Stats

To see how physical characteristics relate to strength, we explored each Pokémon’s height and weight and colored points by total base stats. Many heavier and taller Pokémon tend to have higher stats (brighter colors). Smaller Pokémon show a wide range—some are strong, but many are not. This suggests size plays a role in strength, though it’s not the only factor, which is why we include height and weight as covariates later in the regression model.

```{r p5_height_weight_singletrace, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
# Grayscale mapping for base_total: light gray -> charcoal
rng_total <- range(poke$base_total, na.rm = TRUE)
scale_total <- scales::rescale(poke$base_total, to = c(0, 1), from = rng_total)

grey_start <- grDevices::col2rgb("#d9d9d9") / 255
grey_end   <- grDevices::col2rgb("#333333") / 255
grey_rgb   <- cbind(
  grey_start[1] + scale_total * (grey_end[1] - grey_start[1]),
  grey_start[2] + scale_total * (grey_end[2] - grey_start[2]),
  grey_start[3] + scale_total * (grey_end[3] - grey_start[3])
)
grey_hex   <- grDevices::rgb(grey_rgb[,1], grey_rgb[,2], grey_rgb[,3])

# More colorful pale type tint for marker outline (halo)
type_pale <- function(hex, alpha = 0.40, lighten_mix = 0.35) {
  if (is.na(hex) || hex == "") return("rgba(85,85,85,0.25)")
  rgb <- grDevices::col2rgb(hex) / 255
  r <- rgb[1] + (1 - rgb[1]) * lighten_mix
  g <- rgb[2] + (1 - rgb[2]) * lighten_mix
  b <- rgb[3] + (1 - rgb[3]) * lighten_mix
  paste0("rgba(", round(r * 255), ",", round(g * 255), ",", round(b * 255), ",", alpha, ")")
}

poke_hw <- poke |>
  select(
    name, type1, type2, generation, color_hex,
    height_m, weight_kg,
    hp, attack, defense, sp_attack, sp_defense, speed, base_total
  ) |>
  mutate(
    dot_grey   = grey_hex,
    halo_rgba  = vapply(color_hex, type_pale, character(1)),
    hover_hw = paste0(
      "<b style='font-size:13px;'>", name, "</b>",
      "<br><span style='opacity:.8;'>Type:</span> ", type1,
      ifelse(is.na(type2) | type2 == "None", "", paste0(" / ", type2)),
      "<br><span style='opacity:.8;'>Gen:</span> ", generation,
      "<br><span style='opacity:.8;'>Height:</span> ", scales::number(height_m, accuracy = 0.01), " m",
      "<br><span style='opacity:.8;'>Weight:</span> ", scales::number(weight_kg, accuracy = 0.01), " kg",
      "<br><span style='opacity:.8;'>HP:</span> ", hp,
      " • <span style='opacity:.8;'>Atk:</span> ", attack,
      " • <span style='opacity:.8;'>Def:</span> ", defense,
      " • <span style='opacity:.8;'>SpA:</span> ", sp_attack,
      " • <span style='opacity:.8;'>SpD:</span> ", sp_defense,
      " • <span style='opacity:.8;'>Spe:</span> ", speed,
      "<br><span style='opacity:.8;'>Total:</span> ", base_total
    )
  )

sd5 <- SharedData$new(poke_hw, group = "p5_hw")

# Controls: Primary Type + Generation
ctrls5 <- controls_bar(
  tags$div(class = "ctrl", filter_select("p5_type", "Primary Type", sd5, ~type1, multiple = FALSE)),
  tags$div(class = "ctrl", filter_select("p5_gen",  "Generation",  sd5, ~generation, multiple = FALSE))
)

# Single trace: dot uses grayscale by Total; outline simulates colorful halo by Type
p5 <- plot_ly(
  sd5,
  x = ~height_m,
  y = ~weight_kg,
  text = ~hover_hw,
  type = "scatter",
  mode = "markers",
  hovertemplate = "%{text}<extra></extra>"
) |>
  add_markers(
    name = " ",  # avoid auto label
    marker = list(
      size   = 10,              # dot size
      color  = ~dot_grey,       # grayscale by Total
      opacity = 1.0,
      line = list(
        color = ~halo_rgba,     # colorful translucent type "halo" as outline
        width = 8               # thickness of halo
      )
    ),
    showlegend = FALSE
  ) |>
  layout(
    title = list(
      text = "Height vs Weight",
      font = list(family = "PocketMonk, Montserrat, sans-serif", size = 26)
    ),
    xaxis = list(title = "Height (m)"),
    yaxis = list(title = "Weight (kg)"),
    hovermode = "closest",
    hoverlabel = list(namelength = -1)
  )

p5 <- apply_plot_theme(p5)
htmltools::tagList(ctrls5, p5)
```


